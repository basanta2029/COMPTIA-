Transcript




close interactive script
Click one of the buttons to take you to that part of the video.
1. IPsec for Communications
00:04
In this demonstration, we'll look at requiring
00:06
IPsec for communications between two network hosts.
00:09
We'll use a Windows server and a Windows workstation.<br>
00:12
To secure communications with IPsec, we use the
00:15
Windows Defender Firewall with Advanced Security.
00:18
Let's search for Windows Defender Firewall.
00:21
There it is.
00:24
Let's expand this.
00:26
You'll notice that no rules are defined in the connection
00:28
security rules here, so we need to define a new rule.<br>
2. Define Rules
00:32
To define a new rule, you right-click
00:34
Connection Security Rules and create a New Rule.
00:37
The wizard displays.
00:40
First, we choose the type of rule to use for IPsec.
00:44
We have several options.
00:46
We could configure an Isolation rule, which
00:48
restricts connections based on authentication
00:50
criteria such as domain membership or health status.
00:54
We have an Authentication exemption, which will prevent
00:56
authenticated connections with specific computers, in
00:59
other words, it exempts computers from connecting.<br>
01:02
We have Server-to-server rules.
01:04
These authenticate connections between specified computers.
01:08
Tunnel rules authenticate connections between two
01:10
computers; it creates a tunnel between the two.
01:13
We also can create Custom rules.<br>
3. Create an Isolation Rule
01:16
We want to set up an Isolation rule.
01:18
We'll select Isolation.
01:21
Click Next.
01:23
Now, we need to specify how to enforce authentication.
01:26
You can either request to use
01:28
IPsec or require the use of IPsec.
01:32
If you request, the default option is
01:34
the computer that attempts to use IPsec.
01:37
If either computer in the communication channel can't
01:40
use IPsec, it fails over to unsecured communications.<br>
01:43
Notice that this rule is applied to
01:45
both inbound and outbound connections.
01:48
If this rule isn't secure enough, then you
01:50
can increase security by requiring IPSec
01:52
for inbound and outbound connections.
01:55
We'll request authentication for
01:56
inbound and outbound connections.
01:58
Click Next, which is the default option.
02:01
Now, we determine the type of
02:02
authentication method we want to use.<br>
4. Select Authentication Method
02:05
The first option, the Default, is to
02:07
use whatever authentication methods are
02:09
specified in the default IPsec settings.
02:12
Most of the time, you'll use computer-based Kerberos.
02:14
To use Kerberos, both computers must
02:17
be in the same Active Directory forest.<br>
02:20
You also have the option to
02:21
specify Computer and user Kerberos.
02:24
Choosing this option also requires both computers
02:26
to be in the same Active Directory forest.
02:28
The systems must be re-authenticated
02:30
using user authentication.<br>
02:32
In this demo, we'll use Computer authentication.
02:35
There's also an Advanced option.
02:37
After you select Advanced, click Customize.
02:40
Customize allows you to set up
02:42
multiple authentication methods.
02:43
If the first method we set up fails, the system
02:46
defaults to the next available authentication type.
02:49
On the left, we specify the first authentication method.
02:52
If we click Add, the options are a computer
02:54
using Kerberos, a computer using NTLM, or a
02:58
certificate from a trusted certificate authority.<br>
5. Set up Certificates
03:01
That last option is useful if both computers
03:03
aren't in the same Active Directory forest.
03:05
In this case, we can use certificates to
03:07
authenticate both ends of the communication channel.
03:10
We'll configure both computers to trust the issuing
03:13
CA of the certificates used on the computers.
03:16
We'll browse through to select the
03:17
certificates that we want to use.<br>
03:20
We also have the option of using a pre-shared
03:22
key that would be used by both computers.
03:25
It's noted here that this isn't recommended.
03:27
A pre-shared key is the least secure option of these four.
03:31
Let's go ahead and click Cancel.<br>
03:33
On the left, we specify the first authentication method.
03:36
If the authentication doesn't work, the system will use the
03:39
second authentication method we configured here on the right.
03:42
For this demo, both hosts are members of the same domain,
03:45
so we'll use computer-based Kerberos authentication.
03:48
Now we'll click Next.<br>
6. Specify Network Location Profile
03:50
Now, we can specify the network location
03:52
profile to which this rule will be applied.
03:55
Because we have a desktop workstation and a server
03:58
that are members of the same domain and will always be
04:00
attached to the same network, we can select domain.
04:04
However, if you have a roaming computer such
04:06
as a laptop, notebook, or something of that
04:08
sort, this becomes a little more of an issue.<br>
04:11
While at work, the notebook or
04:12
laptop would use the domain profile.
04:15
When the computer is used from home or another
04:17
location, it would use a public or private profile
04:20
on the system, depending on where we connect.
04:22
For our purposes today, we'll
04:23
use all three of these profiles.
04:25
We could turn one or more of them
04:27
off if we wanted to restrict that.
04:29
Now, we need to name this rule.
04:31
We'll enter Request IPsec policy.
04:34
Click Finish.
04:35
At this point, the rule has been configured, but we've
04:38
configured only one-half of the communication channel.<br>
7. Configure Workstation Rule
04:41
We'll go to the workstation side
04:43
and configure the same rule here.
04:45
On the workstation side, we'll go to the Search box and
04:47
type Windows Defender Firewall with Advanced Security.
04:54
We'll go to Connection Security Rules and right-click.
04:57
We'll configure this IPsec rule
04:58
like we did on the server system.
05:01
Click Isolation and then Next.
05:05
Now, we'll click Request authentication
05:07
for inbound and outbound connections.
05:09
We'll go to Computer Kerberos and leave all three.
05:12
We'll name it Request IPsec and click Finish.<br>
8. Initiate Communications
05:17
From the workstation, let's initiate
05:19
communications between these two computers.
05:22
We'll go back to the Search box and open a command prompt.
05:29
We'll ping the IP address of the server system.
05:32
If we don't know the IP address of the server
05:34
system, we can go over to the server system,
05:37
open the Command Prompt, and run ipconfig.<br>
05:42
You can see the server address here: 172.16.50.110.
05:47
Back to our workstation, ping 172.16.50.110.
05:53
We want this to be a continuous ping, so we'll cancel and
05:56
restart it with the -t flag to continuously send pings.<br>
9. Monitor Connection
06:00
You can see we're getting replies from that address.
06:02
That's perfect.
06:03
We've established that we can ping the server.
06:06
The pinging process will continue, and we can
06:08
monitor the connection between the two computers.<br>
06:11
We can see the replies from the
06:12
server, and it just keeps running.
06:15
Now, let's switch back to the server and go back to
06:17
Windows Defender Firewall with Advanced Security.
06:20
We can see the connection rule.
06:23
Let's go to the Monitoring tab
06:24
so we can monitor the connection.<br>
06:27
If we go to the Connection Security Rule, we can see
06:29
that the Request IPsec rule is currently in progress.
06:33
We'll go to Security Associations.
06:35
Here, we can look inside the Main Mode or Quick Mode and see
06:39
the connections between our Windows 11 machine and server.<br>
06:42
We see information that the connection is working.
06:44
There are two modes, the main mode and quick mode
06:47
because IPsec tunnels are built in two different phases.
06:50
Phase one is called main mode.
06:52
Phase two is quick mode.
06:54
Breaking the monitoring information
06:56
into these two modes is useful.
06:57
It allows you to troubleshoot each phase
07:00
of the connection establishment process.<br>
07:02
Here, in Main Mode, we see information about the connection.
07:06
We have the two endpoints here.
07:08
We can see that this address here is the Windows Server.
07:12
This is the workstation address here and the remote address.<br>
07:15
We can also see that we're using
07:17
Kerberos authentication here.
07:19
We're not requiring a second authentication at the moment.
07:22
If we scroll over or look at this side, we can
07:24
see the encryption in the data integrity mode.<br>
07:27
Let's right-click and go to Properties.
07:30
We can see a little more information about the connection.
07:33
Let's click Cancel.
07:35
We can do the same thing for Quick
07:36
Mode and see the same information.
07:38
Again, we can see both ends of the communication:
07:41
a local address and a remote address.
07:44
We can see that AH and ESP are components of quick mode.
07:48
Before we leave Windows Defender Firewall with Advanced
07:51
Security, we want to show you the global settings.<br>
07:53
Recall earlier when we set up our rule.
07:56
We right-clicked Connection Security Rules.
07:59
From there, we clicked New Rule, Request
08:01
authentication, and then authentication method.
08:04
The default is to use the authentication
08:06
method specified in IPsec settings.<br>
10. Configure IPsec Settings in the Firewall
08:09
Now, we can configure IPsec settings in the
08:11
Windows Firewall with Advanced Security.
08:14
That way, we don't have to manually configure
08:16
these settings each time we set up a rule.
08:18
We can use the default option.
08:20
Let's select Cancel.
08:22
Now, we'll go to Windows Defender Firewall
08:24
with Advanced Security, right-click, go to
08:27
Properties, and then go to the IPsec tab.<br>
08:30
Here, we configure the IPsec setting defaults.
08:34
These are the settings applied unless you
08:36
override them manually when you create the rules.
08:39
Let's click Customize.
08:40
We can configure how the key exchange works.
08:43
Select Advanced, then select Customize,
08:45
and specify the Security methods used.
08:47
We can enter a specific algorithm
08:49
to use or specify key lifetimes.
08:52
These are settings for the main mode;
08:53
data protection is for quick mode.<br>
11. Configure Advanced Settings
08:56
If we click Advanced on data protection from quick mode
08:59
and click Customize on this screen, we can configure the
09:02
AH and ESP algorithms for data integrity and encryption.
09:06
Note that we have the algorithm listed
09:08
first or the algorithm that's used first.
09:11
Remember that integrity ensures that the data hasn't
09:14
been tampered with in transit; that's hashing.<br>
09:17
Encryption encrypts the data so
09:19
that it can't be sniffed and read.
09:21
Let's click Cancel.
09:22
We can configure the default authentication method.
09:26
We can set that to Computer Kerberos if we want.
09:29
We used that when we set up the rule.
09:31
Let's click Cancel because we don't
09:33
want to set these defaults right now.
09:34
Click Cancel again.<br>
12. Review Tools
09:36
The last thing we need to review is the tools you can
09:39
use to manage IPsec communications from the command line.
09:42
Let's go to the command prompt.
09:47
We'll type netsh advfirewall and ?.
09:52
It displays the commands we have available.
09:54
We'll use the consec command.
09:57
Let's press Up and run the consec command.<br>
10:00
Here, you see the commands available within this context.
10:03
We can add a new connection, delete all matching
10:05
connection security rules, display the
10:07
configuration script, display a list of commands,
10:10
set new values for properties of an existing rule,
10:14
and display a specified connection security rule.<br>
13. Summary
10:17
That's it for this demonstration.
10:18
In this demonstration, we used IPsec to secure
10:21
communications between two network hosts.
10:24
We used Windows Firewall with Advanced Security to set up
10:27
connection security rules on both sides of the communication.<br>
10:30
We also set up secured communications between a
10:33
Windows server system and a Windows client system.
10:36
We then used the ping command to establish
10:38
communications between the two hosts.
10:40
We monitored the connection to verify that IPsec was
10:43
being used to secure communications between them.
10:46
We then talked about configuring the IPsec defaults.
10:49
We ended this demonstration by talking about how
10:51
you can manage IPsec rules from the command line.<br>